<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>매출 입력기 (최종 검증)</title>
  <style>
    body {font-family: -apple-system, sans-serif; margin:0; background:#f9f9f9; padding:15px;}
    .container {background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1);}
    table {width:100%; border-collapse:collapse; margin:15px 0;}
    th, td {border:1px solid #ddd; padding:12px; text-align:left; font-size:15px;}
    th {background:#f0f0f0;}
    input, textarea {width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:15px;}
    .total {background:#e3f2fd; font-weight:bold;}
    button {padding:14px; margin:8px 0; border:none; border-radius:8px; color:#fff; font-size:16px; cursor:pointer; width:100%;}
    .save {background:#007bff;}
    .clear {background:#6c757d;}
    .delete {background:#dc3545;}
    .export {background:#28a745;}
    .import {background:#17a2b8;}
    .paste {background:#fd7e14;}
    .cumulative {background:#fff8e1; padding:15px; border-radius:8px; margin:15px 0; font-size:15px;}
    .info {background:#d1ecf1; padding:12px; border-radius:8px; margin-bottom:15px; font-size:14px;}
    .data-list {background:#f8f9fa; padding:15px; border-radius:8px; margin:10px 0; max-height:400px; overflow-y:auto;}
    .data-item {display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;}
    .date-btn {background:#007bff; color:#fff; padding:8px 12px; border-radius:6px; font-size:14px;}
    .delete-btn {background:#dc3545; color:#fff; padding:8px 12px; border-radius:6px; font-size:14px;}
    .result-list {background:#f8f9fa; padding:15px; border-radius:8px; margin:10px 0;}
    .result-item {display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;}
    .success {color:#28a745;}
    .fail {color:#dc3545;}
    .warning {background:#fff3cd; color:#856404; padding:12px; border-radius:8px; margin:15px 0; font-size:13px; text-align:center; border:1px solid #ffeaa7;}
  </style>
</head>
<body>
<div class="container">
  <h2 style="text-align:center; margin-bottom:20px;">매출 입력기 (최종 검증)</h2>

  <div class="info">
    <strong>복붙 or 수동 입력</strong><br>
    엑셀: 숫자만 → 열 분리 없음 + 정렬/합계 가능
  </div>

  <button class="paste" onclick="openPaste()">카톡 복붙 입력</button>

  <h3 style="margin:20px 0 10px;">수동 입력</h3>
  <table id="form">
    <tr><th>항목</th><th>입력</th></tr>
    <tr><td>날짜</td><td><input type="text" id="date" placeholder="11/9" /></td></tr>
    <tr><td>홀</td><td><input type="number" id="hol" oninput="calc()" /></td></tr>
    <tr><td>배</td><td><input type="number" id="bae" oninput="calc()" /></td></tr>
    <tr><td>쿠</td><td><input type="number" id="ku"  oninput="calc()" /></td></tr>
    <tr><td>요</td><td><input type="number" id="yo"  oninput="calc()" /></td></tr>
    <tr class="total"><td>합계</td><td id="total">0 원</td></tr>
    <tr><td>카오위</td><td><input type="number" step="0.1" id="kaowi" /></td></tr>
    <tr><td>순살</td><td><input type="number" step="0.1" id="sunsal" /></td></tr>
    <tr><td>익일 근무자</td><td><textarea id="worker" rows="2"></textarea></td></tr>
    <tr><td>익일 휴무자</td><td><textarea id="off" rows="2"></textarea></td></tr>
  </table>

  <button class="save" onclick="saveManual()">수동 저장</button>
  <button class="clear" onclick="resetForm()">입력 초기화</button>
  <button class="delete" onclick="deleteAll()">전체 삭제</button>
  <button class="export" onclick="exportCSV()">엑셀 내보내기</button>
  <button class="import" onclick="openImport()">엑셀 불러오기</button>

  <div id="resultSummary" class="success" style="display:none; text-align:center; font-weight:bold;"></div>
  <div id="resultList" class="result-list" style="display:none;"></div>

  <h3 style="margin:20px 0 10px;">저장된 데이터 (클릭하여 수정)</h3>
  <div id="dataList" class="data-list"><p>데이터 없음</p></div>

  <div class="cumulative" id="cumulative"><strong>데이터 없음</strong></div>

  <div class="warning">
    <strong>무단 사용 및 배포 금지</strong><br>
    제작자 : reoasterhealing@gmail.com<br>
    본 앱은 내부용으로 제작되었으며, 무단 복제·배포·상업적 이용 시 법적 책임이 따를 수 있습니다.
  </div>
</div>

<!-- 복붙 팝업 -->
<div id="pasteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:999;">
  <div style="background:#fff; margin:15% auto; padding:20px; width:90%; max-width:500px; border-radius:12px;">
    <h3>카톡 복붙 입력</h3>
    <textarea id="pasteText" placeholder="카톡 메시지 붙여넣기" style="width:100%; height:250px; padding:10px; font-size:14px;"></textarea>
    <div style="text-align:center; margin-top:15px;">
      <button onclick="parseKakao()" style="background:#007bff; color:#fff; padding:12px 20px; border:none; border-radius:8px;">자동 파싱 & 저장</button>
      <button onclick="closePaste()" style="background:#6c757d; color:#fff; padding:12px 20px; border:none; border-radius:8px; margin-left:10px;">취소</button>
    </div>
  </div>
</div>

<!-- 엑셀 불러오기 팝업 -->
<div id="importModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:999;">
  <div style="background:#fff; margin:15% auto; padding:20px; width:90%; max-width:500px; border-radius:12px;">
    <h3>엑셀 불러오기</h3>
    <input type="file" id="csvFile" accept=".csv" style="width:100%; padding:10px; margin:10px 0;" />
    <div style="text-align:center;">
      <button onclick="importCSV()" style="background:#17a2b8; color:#fff; padding:12px 20px; border:none; border-radius:8px;">불러오기</button>
      <button onclick="closeImport()" style="background:#6c757d; color:#fff; padding:12px 20px; border:none; border-radius:8px; margin-left:10px;">취소</button>
    </div>
  </div>
</div>

<script>
const KEY = 'salesData';

function calc() {
  const sum = ['hol','bae','ku','yo'].reduce((s, id) => s + (parseFloat(document.getElementById(id).value) || 0), 0);
  document.getElementById('total').textContent = sum.toLocaleString() + ' 원';
}

function saveManual() {
  const date = normalizeDate(document.getElementById('date').value);
  if (!date) return alert('날짜 입력');
  const total = parseNum(document.getElementById('total').textContent);
  if (total === 0) return alert('매출 입력');

  const data = {
    date: date,
    hol: +document.getElementById('hol').value || 0,
    bae: +document.getElementById('bae').value || 0,
    ku: +document.getElementById('ku').value || 0,
    yo: +document.getElementById('yo').value || 0,
    total: total,
    kaowi: +document.getElementById('kaowi').value || 0,
    sunsal: +document.getElementById('sunsal').value || 0,
    worker: document.getElementById('worker').value.trim(),
    off: document.getElementById('off').value.trim()
  };

  let list = JSON.parse(localStorage.getItem(KEY) || '[]');
  const index = list.findIndex(r => r.date === date);
  if (index !== -1) {
    if (!confirm('같은 날짜가 있습니다. 덮어쓰시겠습니까?')) return;
    list[index] = data;
  } else {
    list.push(data);
  }
  localStorage.setItem(KEY, JSON.stringify(list));

  alert('저장 완료');
  resetForm();
  loadDataList();
  updateCum();
}

function resetForm() {
  document.getElementById('form').reset();
  calc();
}

function deleteAll() {
  if (confirm('모든 데이터 삭제?')) {
    localStorage.setItem(KEY, '[]');
    loadDataList();
    updateCum();
    alert('삭제 완료');
  }
}

function loadDataList() {
  let list = JSON.parse(localStorage.getItem(KEY) || '[]');
  list.sort((a, b) => a.date.localeCompare(b.date));
  let html = '';
  list.forEach((r, i) => {
    const formatted = r.date.replace(/(\d{2})-(\d{2})/, '$1/$2');
    html += '<div class="data-item"><button class="date-btn" onclick="editData(' + i + ')">' + formatted + '</button><button class="delete-btn" onclick="deleteSingle(' + i + ')">삭제</button></div>';
  });
  document.getElementById('dataList').innerHTML = html || '<p>데이터 없음</p>';
}

function editData(index) {
  const list = JSON.parse(localStorage.getItem(KEY) || '[]');
  const data = list[index];
  if (!data) return;

  document.getElementById('date').value = data.date.replace(/(\d{2})-(\d{2})/, '$1/$2');
  document.getElementById('hol').value = data.hol;
  document.getElementById('bae').value = data.bae;
  document.getElementById('ku').value = data.ku;
  document.getElementById('yo').value = data.yo;
  document.getElementById('kaowi').value = data.kaowi;
  document.getElementById('sunsal').value = data.sunsal;
  document.getElementById('worker').value = data.worker;
  document.getElementById('off').value = data.off;
  calc();

  document.getElementById('form').scrollIntoView({behavior: 'smooth'});
  alert('수정할 데이터 불러옴 → 저장 버튼 누르세요');
}

function deleteSingle(index) {
  if (confirm('이 날짜 데이터를 삭제하시겠습니까?')) {
    let list = JSON.parse(localStorage.getItem(KEY) || '[]');
    list.splice(index, 1);
    localStorage.setItem(KEY, JSON.stringify(list));
    loadDataList();
    updateCum();
  }
}

function exportCSV() {
  let list = JSON.parse(localStorage.getItem(KEY) || '[]');
  if (!list.length) return alert('데이터 없음');

  list.sort((a, b) => a.date.localeCompare(b.date));

  let csv = '\ufeff날짜,요일,홀,배,쿠,요,일일합계,카오위,순살,익일근무자,익일휴무자\n';
  let sum = {hol:0, bae:0, ku:0, yo:0, total:0, kaowi:0, sunsal:0};

  list.forEach(r => {
    const [month, day] = r.date.split('-');
    const dateObj = new Date(2025, parseInt(month)-1, parseInt(day));
    const yoil = dateObj.toLocaleDateString('ko-KR', {weekday:'short'});
    csv += r.date + ',' + yoil + ',' + r.hol + ',' + r.bae + ',' + r.ku + ',' + r.yo + ',' + r.total + ',' + r.kaowi.toFixed(1) + ',' + r.sunsal.toFixed(1) + ',' + r.worker + ',' + r.off + '\n';
    sum.hol += r.hol; sum.bae += r.bae; sum.ku += r.ku; sum.yo += r.yo;
    sum.total += r.total; sum.kaowi += r.kaowi; sum.sunsal += r.sunsal;
  });
  csv += '합계,-,' + sum.hol + ',' + sum.bae + ',' + sum.ku + ',' + sum.yo + ',' + sum.total + ',' + sum.kaowi.toFixed(1) + ',' + sum.sunsal.toFixed(1) + ',,\n';

  const fileName = '매출_전체_' + new Date().toISOString().slice(0,10) + '.csv';
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = fileName; a.click();
  URL.revokeObjectURL(url);
}

function openImport() {
  document.getElementById('importModal').style.display = 'block';
}
function closeImport() {
  document.getElementById('importModal').style.display = 'none';
  document.getElementById('csvFile').value = '';
}
function importCSV() {
  const file = document.getElementById('csvFile').files[0];
  if (!file) return alert('파일 선택');
  if (!file.name.endsWith('.csv')) return alert('CSV 파일만 가능');

  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const lines = text.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('합계'));
    let imported = 0;
    let list = JSON.parse(localStorage.getItem(KEY) || '[]');

    lines.forEach(line => {
      const cols = line.split(',');
      if (cols.length < 9) return;
      const date = cols[0];
      if (!/^\d{2}-\d{2}$/.test(date)) return;
      if (list.some(r => r.date === date)) return;

      const data = {
        date: date,
        hol: parseInt(cols[2]) || 0,
        bae: parseInt(cols[3]) || 0,
        ku: parseInt(cols[4]) || 0,
        yo: parseInt(cols[5]) || 0,
        total: parseInt(cols[6]) || 0,
        kaowi: parseFloat(cols[7]) || 0,
        sunsal: parseFloat(cols[8]) || 0,
        worker: cols[9] || '',
        off: cols[10] || ''
      };
      list.push(data);
      imported++;
    });

    localStorage.setItem(KEY, JSON.stringify(list));
    closeImport();
    loadDataList();
    updateCum();
    alert('불러오기 완료: ' + imported + '건 추가');
  };
  reader.readAsText(file);
}

function parseKakao() {
  let text = document.getElementById('pasteText').value;
  text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\u00A0/g, ' ').trim();
  if (!text) return alert('텍스트를 붙여넣으세요.');

  const lines = text.split('\n').map(l => l.trim()).filter(l => l);
  const results = [];
  let savedCount = 0;
  let entry = null;

  lines.forEach(line => {
    line = line.replace(/\s+/g, ' ').trim();
    if (/^\d+\/\d+/.test(line)) {
      if (entry && entry.total > 0) {
        saveEntry(entry, results);
        savedCount++;
      }
      entry = { date: line.match(/^\d+\/\d+/)[0], hol: 0, bae: 0, ku: 0, yo: 0, total: 0, kaowi: 0, sunsal: 0, worker: '', off: '' };
    } else if (entry) {
      if (/홀/.test(line)) entry.hol = parseNum(line);
      else if (/배/.test(line)) entry.bae = parseNum(line);
      else if (/쿠/.test(line)) entry.ku = parseNum(line);
      else if (/요/.test(line)) entry.yo = parseNum(line);
      else if (/합/.test(line)) entry.total = parseNum(line);
      else if (/카오위/.test(line)) entry.kaowi = parseFloat(line.replace(/[^\d.]/g, '')) || 0;
      else if (/순살/.test(line)) entry.sunsal = parseFloat(line.replace(/[^\d.]/g, '')) || 0;
      else if (/근무자/.test(line)) entry.worker = line.split(/근무자[:\s]*/)[1]?.trim() || '';
      else if (/휴무자/.test(line)) entry.off = line.split(/휴무자[:\s]*/)[1]?.trim() || '';
    }
  });

  if (entry && entry.total > 0) {
    saveEntry(entry, results);
    savedCount++;
  } else if (entry) {
    results.push({ date: entry.date || '알 수 없음', status: 'fail' });
  }

  closePaste();
  displayResults(results, savedCount);
  loadDataList();
  updateCum();
}

function saveEntry(entry, results) {
  const normDate = normalizeDate(entry.date);
  if (!normDate) {
    results.push({ date: entry.date, status: 'fail' });
    return;
  }
  let list = JSON.parse(localStorage.getItem(KEY) || '[]');
  if (list.some(r => r.date === normDate)) {
    results.push({ date: normDate, status: 'duplicate' });
    return;
  }
  const data = { date: normDate, hol: entry.hol, bae: entry.bae, ku: entry.ku, yo: entry.yo,
    total: entry.total, kaowi: entry.kaowi, sunsal: entry.sunsal, worker: entry.worker, off: entry.off };
  list.push(data);
  localStorage.setItem(KEY, JSON.stringify(list));
  results.push({ date: normDate, status: 'success' });
}

function parseNum(str) {
  const num = str.replace(/[^\d]/g, '');
  return num ? parseInt(num, 10) : 0;
}

function normalizeDate(d) {
  const match = d.match(/(\d+)\/(\d+)/);
  return match ? match[1].padStart(2,'0') + '-' + match[2].padStart(2,'0') : null;
}

function updateCum() {
  const list = JSON.parse(localStorage.getItem(KEY) || '[]');
  if (!list.length) {
    document.getElementById('cumulative').innerHTML = '<strong>데이터 없음</strong>';
    return;
  }
  const total = list.reduce((s, r) => s + r.total, 0);
  const kaowi = list.reduce((s, r) => s + r.kaowi, 0);
  const sunsal = list.reduce((s, r) => s + r.sunsal, 0);
  const count = list.length;
  document.getElementById('cumulative').innerHTML = '<strong>전체 누적 (' + count + '건)</strong><br>매출: <strong>' + total.toLocaleString() + ' 원</strong><br>카오위: <strong>' + kaowi.toFixed(1) + '</strong> | 순살: <strong>' + sunsal.toFixed(1) + '</strong>';
}

function displayResults(results, saved) {
  const summary = document.getElementById('resultSummary');
  const list = document.getElementById('resultList');
  
  summary.innerHTML = '<strong>총 ' + results.length + '건 중 ' + saved + '건 저장 완료!</strong>';
  summary.style.display = 'block';

  let html = '';
  results.forEach(r => {
    const formatted = r.date.replace(/(\d{2})-(\d{2})/, '$1/$2');
    const icon = r.status === 'success' ? '성공' : (r.status === 'duplicate' ? '중복' : '실패');
    const msg = r.status === 'success' ? '저장' : (r.status === 'duplicate' ? '중복' : '실패');
    html += '<div class="result-item"><span>' + formatted + '</span><span class="' + (r.status === 'success' ? 'success' : 'fail') + '">' + icon + ' ' + msg + '</span></div>';
  });
  list.innerHTML = html;
  list.style.display = 'block';
  setTimeout(() => { summary.style.display = 'none'; list.style.display = 'none'; }, 4000);
}

function openPaste() {
  document.getElementById('pasteModal').style.display = 'block';
  document.getElementById('pasteText').focus();
}
function closePaste() {
  document.getElementById('pasteModal').style.display = 'none';
  document.getElementById('pasteText').value = '';
}

window.onload = function() {
  calc();
  loadDataList();
  updateCum();
};
</script>
</body>
</html>

