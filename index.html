<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë§¤ì¶œ ì…ë ¥ê¸° (ìµœì¢… ì™„ì„±)</title>
  <style>
    body {font-family: -apple-system, sans-serif; margin:0; background:#f9f9f9; padding:15px;}
    .container {background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1);}
    table {width:100%; border-collapse:collapse; margin:15px 0;}
    th, td {border:1px solid #ddd; padding:12px; text-align:left; font-size:15px;}
    th {background:#f0f0f0;}
    input, textarea {width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:15px;}
    .total {background:#e3f2fd; font-weight:bold;}
    button {padding:14px; margin:8px 0; border:none; border-radius:8px; color:#fff; font-size:16px; cursor:pointer; width:100%;}
    .save {background:#007bff;}
    .clear {background:#6c757d;}
    .delete {background:#dc3545 direttamente;}
    .export {background:#28a745;}
    .paste {background:#fd7e14;}
    .cumulative {background:#fff8e1; padding:15px; border-radius:8px; margin:15px 0; font-size:15px;}
    .info {background:#d1ecf1; padding:12px; border-radius:8px; margin-bottom:15px; font-size:14px;}
    .data-list {background:#f8f9fa; padding:15px; border-radius:8px; margin:10px 0; max-height:400px; overflow-y:auto;}
    .data-item {display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;}
    .date-btn {background:#007bff; color:#fff; padding:8px 12px; border-radius:6px; font-size:14px;}
    .delete-btn {background:#dc3545; color:#fff; padding:8px 12px; border-radius:6px; font-size:14px;}
    .result-list {background:#f8f9fa; padding:15px; border-radius:8px; margin:10px 0;}
    .result-item {display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;}
    .success {color:#28a745;}
    .fail {color:#dc3545;}
    .warning {background:#fff3cd; color:#856404; padding:12px; border-radius:8px; margin:15px 0; font-size:13px; text-align:center; border:1px solid #ffeaa7;}
  </style>
</head>
<body>
<div class="container">
  <h2 style="text-align:center; margin-bottom:20px;">ë§¤ì¶œ ì…ë ¥ê¸° (ìµœì¢… ì™„ì„±)</h2>

  <div class="info">
    <strong>ë³µë¶™ or  ìˆ˜ë™ ì…ë ¥</strong><br>
    ì—‘ì…€: ìˆ«ìë§Œ â†’ ì—´ ë¶„ë¦¬ ì—†ìŒ + ì •ë ¬/í•©ê³„ ê°€ëŠ¥
  </div>

  <button class="paste" onclick="openPaste()">ì¹´í†¡ ë³µë¶™ ì…ë ¥</button>

  <h3 style="margin:20px 0 10px;"> ìˆ˜ë™ ì…ë ¥</h3>
  <table id="form">
    <tr><th>í•­ëª©</th><th>ì…ë ¥</th></tr>
    <tr><td>ë‚ ì§œ</td><td><input type="text" id="date" placeholder="11/9" /></td></tr>
    <tr><td>í™€</td><td><input type="number" id="hol" oninput="calc()" /></td></tr>
    <tr><td>ë°°</td><td><input type="number" id="bae" oninput="calc()" /></td></tr>
    <tr><td>ì¿ </td><td><input type="number" id="ku"  oninput="calc()" /></td></tr>
    <tr><td>ìš”</td><td><input type="number" id="yo"  oninput="calc()" /></td></tr>
    <tr class="total"><td>í•©ê³„</td><td id="total">0 ì›</td></tr>
    <tr><td>ì¹´ì˜¤ìœ„</td><td><input type="number" step="0.1" id="kaowi" /></td></tr>
    <tr><td>ìˆœì‚´</td><td><input type="number" step="0.1" id="sunsal" /></td></tr>
    <tr><td>ìµì¼ ê·¼ë¬´ì</td><td><textarea id="worker" rows="2"></textarea></td></tr>
    <tr><td>ìµì¼ íœ´ë¬´ì</td><td><textarea id="off" rows="2"></textarea></td></tr>
  </table>

  <button class="save" onclick="saveManual()">ìˆ˜ë™ ì €ì¥</button>
  <button class="clear" onclick="resetForm()">ì…ë ¥ ì´ˆê¸°í™”</button>
  <button class="delete" onclick="deleteAll()">ì „ì²´ ì‚­ì œ</button>
  <button class="export" onclick="exportCSV()">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>

  <div id="resultSummary" class="success" style="display:none; text-align:center; font-weight:bold;"></div>
  <div id="resultList" class="result-list" style="display:none;"></div>

  <h3 style="margin:20px 0 10px;">ğŸ“‹ ì €ì¥ëœ ë°ì´í„° (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</h3>
  <div id="dataList" class="data-list"><p>ë°ì´í„° ì—†ìŒ</p></div>

  <div class="cumulative" id="cumulative"><strong>ë°ì´í„° ì—†ìŒ</strong></div>

  <!-- ë¬´ë‹¨ì‚¬ìš© ê¸ˆì§€ ë¬¸êµ¬ ì¶”ê°€ -->
  <div class="warning">
    <strong>âš ï¸ ë¬´ë‹¨ ì‚¬ìš© ë° ë°°í¬ ê¸ˆì§€ âš ï¸</strong><br>
    ì œì‘ì:roasterhealing@gmail.com <br>
    ë³¸ ì•±ì€ ë‚´ë¶€ìš©ìœ¼ë¡œ ì œì‘ë˜ì—ˆìœ¼ë©°, ë¬´ë‹¨ ë³µì œÂ·ë°°í¬Â·ìƒì—…ì  ì´ìš© ì‹œ ë²•ì  ì±…ì„ì´ ë”°ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  </div>
</div>

<!-- ë³µë¶™ íŒì—… -->
<div id="pasteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:999;">
  <div style="background:#fff; margin:15% auto; padding:20px; width:90%; max-width:500px; border-radius:12px;">
    <h3>ì¹´í†¡ ë³µë¶™ ì…ë ¥</h3>
    <textarea id="pasteText" placeholder="ì¹´í†¡ ë©”ì‹œì§€ ë¶™ì—¬ë„£ê¸°" style="width:100%; height:250px; padding:10px; font-size:14px;"></textarea>
    <div style="text-align:center; margin-top:15px;">
      <button onclick="parseKakao()" style="background:#007bff; color:#fff; padding:12px 20px; border:none; border-radius:8px;">ìë™ íŒŒì‹± & ì €ì¥</button>
      <button onclick="closePaste()" style="background:#6c757d; color:#fff; padding:12px 20px; border:none; border-radius:8px; margin-left:10px;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script>
const KEY = 'salesData';

// ìˆ˜ë™ ì…ë ¥ ê³„ì‚° (ì•± ë‚´ëŠ” ì½¤ë§ˆ + ì› ìœ ì§€)
function calc() {
  const sum = ['hol','bae','ku','yo'].reduce((s, id) => s + (parseFloat(document.getElementById(id).value) || 0), 0);
  document.getElementById('total').textContent = sum.toLocaleString() + ' ì›';
}

// ìˆ˜ë™ ì €ì¥
function saveManual() {
  const date = normalizeDate(document.getElementById('date').value);
  if (!date) return alert('ë‚ ì§œ ì…ë ¥');
  const total = parseNum(document.getElementById('total').textContent);
  if (total === 0) return alert('ë§¤ì¶œ ì…ë ¥');

  const data = {
    date, hol: +document.getElementById('hol').value || 0,
    bae: +document.getElementById('bae').value || 0,
    ku: +document.getElementById('ku').value || 0,
    yo: +document.getElementById('yo').value || 0,
    total, kaowi: +document.getElementById('kaowi').value || 0,
    sunsal: +document.getElementById('sunsal').value || 0,
    worker: document.getElementById('worker').value.trim(),
    off: document.getElementById('off').value.trim()
  };

  let list = JSON.parse(localStorage.getItem(KEY) || '[]');
  const index = list.findIndex(r => r.date === date);
  if (index !== -1) {
    if (!confirm('ê°™ì€ ë‚ ì§œê°€ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    list[index] = data;
  } else {
    list.push(data);
  }
  localStorage.setItem(KEY, JSON.stringify(list));

  alert('ì €ì¥ ì™„ë£Œ');
  resetForm();
  loadDataList();
  updateCum();
}

// ì…ë ¥ ì´ˆê¸°í™”
function resetForm() {
  document.getElementById('form').reset();
  calc();
}

// ì „ì²´ ì‚­ì œ
function deleteAll() {
  if (confirm('âš ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ?')) {
    localStorage.setItem(KEY, '[]');
    loadDataList();
    updateCum();
    alert('ì‚­ì œ ì™„ë£Œ');
  }
}

// ë°ì´í„° ëª©ë¡ ë¡œë“œ
function loadDataList() {
  let list = JSON.parse(localStorage.getItem(KEY) || '[]');
  list.sort((a, b) => a.date.localeCompare(b.date));
  let html = '';
  list.forEach((r, i) => {
    const formatted = r.date.replace(/(\d{2})-(\d{2})/, '$1/$2');
    html += `
      <div class="data-item">
        <button class="date-btn" onclick="editData(${i})">${formatted}</button>
        <button class="delete-btn" onclick="deleteSingle(${i})">ì‚­ì œ</button>
      </div>
    `;
  });
  document.getElementById('dataList').innerHTML = html || '<p>ë°ì´í„° ì—†ìŒ</p>';
}

// ê°œë³„ ìˆ˜ì •
function editData(index) {
  const list = JSON.parse(localStorage.getItem(KEY) || '[]');
  const data = list[index];
  if (!data) return;

  document.getElementById('date').value = data.date.replace(/(\d{2})-(\d{2})/, '$1/$2');
  document.getElementById('hol').value = data.hol;
  document.getElementById('bae').value = data.bae;
  document.getElementById('ku').value = data.ku;
  document.getElementById('yo').value = data.yo;
  document.getElementById('kaowi').value = data.kaowi;
  document.getElementById('sunsal').value = data.sunsal;
  document.getElementById('worker').value = data.worker;
  document.getElementById('off').value = data.off;
  calc();

  document.getElementById('form').scrollIntoView({behavior: 'smooth'});
  alert('ìˆ˜ì •í•  ë°ì´í„° ë¶ˆëŸ¬ì˜´ â†’ ì €ì¥ ë²„íŠ¼ ëˆ„ë¥´ì„¸ìš”');
}

// ê°œë³„ ì‚­ì œ
function deleteSingle(index) {
  if (confirm('ì´ ë‚ ì§œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    let list = JSON.parse(localStorage.getItem(KEY) || '[]');
    list.splice(index, 1);
    localStorage.setItem(KEY, JSON.stringify(list));
    loadDataList();
    updateCum();
  }
}

// ì—‘ì…€ ë‚´ë³´ë‚´ê¸° (ìˆ«ìë§Œ)
function exportCSV() {
  let list = JSON.parse(localStorage.getItem(KEY) || '[]');
  if (!list.length) return alert('ë°ì´í„° ì—†ìŒ');

  list.sort((a, b) => a.date.localeCompare(b.date));

  let csv = '\ufeffë‚ ì§œ,ìš”ì¼,í™€,ë°°,ì¿ ,ìš”,ì¼ì¼í•©ê³„,ì¹´ì˜¤ìœ„,ìˆœì‚´,ìµì¼ê·¼ë¬´ì,ìµì¼íœ´ë¬´ì\n';
  let sum = {hol:0, bae:0, ku:0, yo:0, total:0, kaowi:0, sunsal:0};

  list.forEach(r => {
    const [month, day] = r.date.split('-');
    const dateObj = new Date(2025, parseInt(month)-1, parseInt(day));
    const yoil = dateObj.toLocaleDateString('ko-KR', {weekday:'short'});
    
    csv += `${r.date},${yoil},${r.hol},${r.bae},${r.ku},${r.yo},${r.total},${r.kaowi.toFixed(1)},${r.sunsal.toFixed(1)},${r.worker},${r.off}\n`;
    
    sum.hol += r.hol; sum.bae += r.bae; sum.ku += r.ku; sum.yo += r.yo;
    sum.total += r.total; sum.kaowi += r.kaowi; sum.sunsal += r.sunsal;
  });

  csv += `í•©ê³„,-,${sum.hol},${sum.bae},${sum.ku},${sum.yo},${sum.total},${sum.kaowi.toFixed(1)},${sum.sunsal.toFixed(1)},,\n`;

  const fileName = `ë§¤ì¶œ_ì „ì²´_${new Date().toISOString().slice(0,10)}.csv`;
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = fileName; a.click();
  URL.revokeObjectURL(url);
}

// ì¹´í†¡ ë³µë¶™ íŒŒì‹±
function parseKakao() {
  let text = document.getElementById('pasteText').value;
  text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\u00A0/g, ' ').trim();
  if (!text) return alert('í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');

  const lines = text.split('\n').map(l => l.trim()).filter(l => l);
  const results = [];
  let savedCount = 0;
  let entry = null;

  lines.forEach(line => {
    line = line.replace(/\s+/g, ' ').trim();
    if (/^\d+\/\d+/.test(line)) {
      if (entry && entry.total > 0) {
        saveEntry(entry, results);
        savedCount++;
      }
      entry = { date: line.match(/^\d+\/\d+/)[0], hol: 0, bae: 0, ku: 0, yo: 0, total: 0, kaowi: 0, sunsal: 0, worker: '', off: '' };
    } else if (entry) {
      if (/í™€/.test(line)) entry.hol = parseNum(line);
      else if (/ë°°/.test(line)) entry.bae = parseNum(line);
      else if (/ì¿ /.test(line)) entry.ku = parseNum(line);
      else if (/ìš”/.test(line)) entry.yo = parseNum(line);
      else if (/í•©/.test(line)) entry.total = parseNum(line);
      else if (/ì¹´ì˜¤ìœ„/.test(line)) entry.kaowi = parseFloat(line.replace(/[^\d.]/g, '')) || 0;
      else if (/ìˆœì‚´/.test(line)) entry.sunsal = parseFloat(line.replace(/[^\d.]/g, '')) || 0;
      else if (/ê·¼ë¬´ì/.test(line)) entry.worker = line.split(/ê·¼ë¬´ì[:\s]*/)[1]?.trim() || '';
      else if (/íœ´ë¬´ì/.test(line)) entry.off = line.split(/íœ´ë¬´ì[:\s]*/)[1]?.trim() || '';
    }
  });

  if (entry && entry.total > 0) {
    saveEntry(entry, results);
    savedCount++;
  } else if (entry) {
    results.push({ date: entry.date || 'ì•Œ ìˆ˜ ì—†ìŒ', status: 'fail' });
  }

  closePaste();
  displayResults(results, savedCount);
  loadDataList();
  updateCum();
}

function saveEntry(entry, results) {
  const normDate = normalizeDate(entry.date);
  if (!normDate) {
    results.push({ date: entry.date, status: 'fail' });
    return;
  }
  let list = JSON.parse(localStorage.getItem(KEY) || '[]');
  if (list.some(r => r.date === normDate)) {
    results.push({ date: normDate, status: 'duplicate' });
    return;
  }
  const data = { date: normDate, hol: entry.hol, bae: entry.bae, ku: entry.ku, yo: entry.yo,
    total: entry.total, kaowi: entry.kaowi, sunsal: entry.sunsal, worker: entry.worker, off: entry.off };
  list.push(data);
  localStorage.setItem(KEY, JSON.stringify(list));
  results.push({ date: normDate, status: 'success' });
}

function parseNum(str) {
  const num = str.replace(/[^\d]/g, '');
  return num ? parseInt(num, 10) : 0;
}

function normalizeDate(d) {
  const match = d.match(/(\d+)\/(\d+)/);
  return match ? `${match[1].padStart(2,'0')}-${match[2].padStart(2,'0')}` : null;
}

function updateCum() {
  const list = JSON.parse(localStorage.getItem(KEY) || '[]');
  if (!list.length) {
    document.getElementById('cumulative').innerHTML = '<strong>ë°ì´í„° ì—†ìŒ</strong>';
    return;
  }
  const total = list.reduce((s, r) => s + r.total, 0);
  const kaowi = list.reduce((s, r) => s + r.kaowi, 0);
  const sunsal = list.reduce((s, r) => s + r.sunsal, 0);
  const count = list.length;
  document.getElementById('cumulative').innerHTML = `
    <strong>ì „ì²´ ëˆ„ì  (${count}ê±´)</strong><br>
    ë§¤ì¶œ: <strong>${total.toLocaleString()} ì›</strong><br>
    ì¹´ì˜¤ìœ„: <strong>${kaowi.toFixed(1)}</strong> | ìˆœì‚´: <strong>${sunsal.toFixed(1)}</strong>
  `;
}

function displayResults(results, saved) {
  const summary = document.getElementById('resultSummary');
  const list = document.getElementById('resultList');
  
  summary.innerHTML = `<strong>ì´ ${results.length}ê±´ ì¤‘ ${saved}ê±´ ì €ì¥ ì™„ë£Œ!</strong>`;
  summary.style.display = 'block';

  let html = '';
  results.forEach(r => {
    const formatted = r.date.replace(/(\d{2})-(\d{2})/, '$1/$2');
    const icon = r.status === 'success' ? 'ì„±ê³µ' : (r.status === 'duplicate' ? 'ì¤‘ë³µ' : 'ì‹¤íŒ¨');
    const msg = r.status === 'success' ? 'ì €ì¥' : (r.status === 'duplicate' ? 'ì¤‘ë³µ' : 'ì‹¤íŒ¨');
    html += `<div class="result-item"><span>${formatted}</span><span class="${r.status === 'success' ? 'success' : 'fail'}">${icon} ${msg}</span></div>`;
  });
  list.innerHTML = html;
  list.style.display = 'block';
  setTimeout(() => { summary.style.display = 'none'; list.style.display = 'none'; }, 4000);
}

function openPaste() {
  document.getElementById('pasteModal').style.display = 'block';
  document.getElementById('pasteText').focus();
}
function closePaste() {
  document.getElementById('pasteModal').style.display = 'none';
  document.getElementById('pasteText').value = '';
}

window.onload = () => {
  calc();
  loadDataList();
  updateCum();
};
</script>
</body>
</html>
